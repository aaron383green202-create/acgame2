<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Ascension - Ultra Final</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background: #050010; font-family: 'Orbitron', sans-serif; touch-action: none; color: #fff; }
        canvas { display: block; background: #000; }
        
        /* UI 介面 */
        #hud { position: absolute; top: 15px; left: 15px; font-size: 16px; color: #00d2ff; pointer-events: none; display: none; background: rgba(0,210,255,0.1); padding: 10px; border: 1px solid #00d2ff; border-radius: 8px; z-index: 10; }
        #menu { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, #100020 0%, #050010 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        .btn-group { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .select-btn { padding: 20px 40px; border: 2px solid #00d2ff; background: none; color: #00d2ff; border-radius: 50px; cursor: pointer; font-size: 20px; font-family: 'Orbitron'; transition: 0.3s; }
        .select-btn:hover { background: #00d2ff; color: #000; box-shadow: 0 0 20px #00d2ff; }
        
        /* 手機控制項 */
        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; display: none; }
        #joy-stick { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: #fff; border-radius: 50%; }
        .controls { position: absolute; bottom: 40px; right: 30px; display: flex; gap: 15px; z-index: 50; }
        .btn-ui { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #fff; display: none; justify-content: center; align-items: center; background: rgba(0,0,0,0.6); font-size: 14px; cursor: pointer; }
        .ult-ready { background: #ff00ff !important; box-shadow: 0 0 20px #ff00ff; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body>
    <div id="hud">
        LV: <span id="lv">1</span> | HP: <span id="hp">5</span> | SC: <span id="sc">0</span><br>
        ULT: <span id="ult-val">0</span>%
    </div>
    
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div class="controls"><div id="fire-btn" class="btn-ui">FIRE</div><div id="ult-btn" class="btn-ui">ULT</div></div>

    <div id="menu">
        <h1 style="text-shadow: 0 0 20px #00d2ff; margin-bottom: 40px;">NEON ASCENSION</h1>
        <div class="btn-group">
            <button class="select-btn" onclick="startGame('sword')">霓虹劍客</button>
            <button class="select-btn" style="border-color:#ff00ff; color:#ff00ff;" onclick="startGame('gunner')">自動獵手</button>
        </div>
        <p style="margin-top: 30px; color: #666;">電腦：WASD 或 方向鍵移動 | 空白鍵攻擊 | Enter 絕招</p>
    </div>

    <canvas id="g"></canvas>

<script>
const cvs = document.getElementById('g'), ctx = cvs.getContext('2d');
let p, enemies = [], bullets = [], active = false, isFiring = false, isBerserk = false;
let score = 0, level = 1, lastE = 0, lastS = 0, lvText = 0;
let joy = { active: false, x: 0, y: 0, dx: 0, dy: 0 };
const keys = {};

function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.onresize = resize; resize();

// --- 強化版鍵盤控制 (修復方向鍵問題) ---
const keyMap = {
    'w': 'w', 'arrowup': 'w',
    's': 's', 'arrowdown': 's',
    'a': 'a', 'arrowleft': 'a',
    'd': 'd', 'arrowright': 'd'
};

window.onkeydown = e => {
    const k = e.key.toLowerCase();
    if(keyMap[k]) keys[keyMap[k]] = true;
    if(k === " " || k === "spacebar") { isFiring = true; e.preventDefault(); }
    if(k === "enter") triggerUlt();
};
window.onkeyup = e => {
    const k = e.key.toLowerCase();
    if(keyMap[k]) keys[keyMap[k]] = false;
    if(k === " " || k === "spacebar") isFiring = false;
};

// --- 手機與滑鼠控制 ---
document.getElementById('fire-btn').ontouchstart = e => { isFiring = true; e.preventDefault(); };
document.getElementById('fire-btn').ontouchend = () => isFiring = false;
document.getElementById('ult-btn').onclick = triggerUlt;
cvs.onmousedown = () => isFiring = true; cvs.onmouseup = () => isFiring = false;

window.ontouchstart = e => {
    if (e.touches[0].clientX < cvs.width / 2) {
        joy.active = true; joy.x = e.touches[0].clientX; joy.y = e.touches[0].clientY;
        document.getElementById('joy-base').style.display = 'block';
        document.getElementById('joy-base').style.left = (joy.x - 50) + 'px'; document.getElementById('joy-base').style.top = (joy.y - 50) + 'px';
    }
};
window.ontouchmove = e => {
    if (!joy.active) return;
    const t = e.touches[0], dx = t.clientX - joy.x, dy = t.clientY - joy.y;
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40), ang = Math.atan2(dy, dx);
    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
    joy.dx = Math.cos(ang) * (dist/40) * 8; joy.dy = Math.sin(ang) * (dist/40) * 8;
};
window.ontouchend = () => { joy.active = false; document.getElementById('joy-base').style.display = 'none'; joy.dx = joy.dy = 0; };

function triggerUlt() { if(p.ult >= 100) { p.ult = 0; isBerserk = true; setTimeout(() => isBerserk = false, 8000); } }

function startGame(type) {
    p = { x: cvs.width/2, y: cvs.height/2, hp: 5, ult: 0, type, swordA: 0 };
    active = true; document.getElementById('menu').style.display = 'none';
    document.getElementById('hud').style.display = 'block';
    document.querySelectorAll('.btn-ui').forEach(b => b.style.display = 'flex');
    update();
}

function update() {
    if(!active) return;
    ctx.fillStyle = 'rgba(5, 0, 20, 0.4)'; ctx.fillRect(0, 0, cvs.width, cvs.height);

    // 1. 移動
    let mx = (keys.a ? -8 : 0) + (keys.d ? 8 : 0) + joy.dx;
    let my = (keys.w ? -8 : 0) + (keys.s ? 8 : 0) + joy.dy;
    p.x = Math.max(20, Math.min(cvs.width-20, p.x + mx));
    p.y = Math.max(20, Math.min(cvs.height-20, p.y + my));

    // 2. 關卡與難度
    let newLv = Math.floor(score / 2500) + 1;
    if(newLv > level) { level = newLv; lvText = 60; p.hp = Math.min(p.hp+1, 5); }

    // 3. 戰鬥系統
    if(p.type === 'sword') {
        let sLen = isBerserk ? 220 : 100;
        p.swordA += isBerserk ? 0.45 : (isFiring ? 0.3 : 0.15);
        const sx = p.x + Math.cos(p.swordA)*sLen, sy = p.y + Math.sin(p.swordA)*sLen;
        ctx.strokeStyle = isBerserk ? '#ff0' : (isFiring ? '#fff' : '#00d2ff');
        ctx.lineWidth = 12; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(sx, sy); ctx.stroke();
        enemies.forEach((en, i) => {
            let t = Math.max(0, Math.min(1, ((en.x-p.x)*(sx-p.x)+(en.y-p.y)*(sy-p.y))/(sLen*sLen)));
            if(Math.hypot(en.x-(p.x+t*(sx-p.x)), en.y-(p.y+t*(sy-p.y))) < 45) { enemies.splice(i, 1); score += 100; p.ult = Math.min(100, p.ult+4); }
        });
    } else {
        if((isFiring || isBerserk) && Date.now() - lastS > (isBerserk ? 100 : 200)) {
            let target = enemies[0];
            let ang = target ? Math.atan2(target.y-p.y, target.x-p.x) : -Math.PI/2;
            bullets.push({x:p.x, y:p.y, vx:Math.cos(ang)*16, vy:Math.sin(ang)*16});
            if(isBerserk) bullets.push({x:p.x, y:p.y, vx:Math.cos(ang+0.4)*16, vy:Math.sin(ang+0.4)*16}, {x:p.x, y:p.y, vx:Math.cos(ang-0.4)*16, vy:Math.sin(ang-0.4)*16});
            lastS = Date.now();
        }
    }

    // 4. 物件更新
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy; ctx.fillStyle = '#ff00ff'; ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, Math.PI*2); ctx.fill();
        enemies.forEach((en, ei) => { if(Math.hypot(b.x-en.x, b.y-en.y) < 30) { enemies.splice(ei, 1); bullets.splice(i, 1); score += 100; p.ult = Math.min(100, p.ult+5); } });
    });

    if(Date.now() - lastE > Math.max(250, 1000 - level*100)) {
        enemies.push({x: Math.random()*cvs.width, y: -40, s: 3.5 + level*0.4});
        lastE = Date.now();
    }
    enemies.forEach((en, i) => {
        let a = Math.atan2(p.y-en.y, p.x-en.x); en.x += Math.cos(a)*en.s; en.y += Math.sin(a)*en.s;
        ctx.fillStyle = '#ff4444'; ctx.fillRect(en.x-14, en.y-14, 28, 28);
        if(!isBerserk && Math.hypot(p.x-en.x, p.y-en.y) < 26) { p.hp--; enemies.splice(i, 1); if(p.hp<=0) location.reload(); }
    });

    // 5. 繪製
    ctx.fillStyle = isBerserk ? '#ff0' : (p.type==='sword'?'#00d2ff':'#ff00ff');
    ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
    ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
    if(lvText > 0) { ctx.fillStyle = '#00d2ff'; ctx.font = 'bold 50px Orbitron'; ctx.textAlign='center'; ctx.fillText("LEVEL UP!", cvs.width/2, cvs.height/2); lvText--; }

    document.getElementById('lv').innerText = level; document.getElementById('hp').innerText = p.hp;
    document.getElementById('sc').innerText = score; document.getElementById('ult-val').innerText = Math.floor(p.ult);
    document.getElementById('ult-btn').className = 'btn-ui' + (p.ult>=100 ? ' ult-ready' : '');
    requestAnimationFrame(update);
}
</script>
</body>
</html>
