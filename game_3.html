<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D 賽車 - 激烈對戰版</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #0ff; background: rgba(0,0,0,0.8); padding: 12px; border-left: 4px solid #0ff; z-index: 100; border-radius: 4px; }
        #timer-box { position: absolute; top: 20px; right: 20px; color: #f44; background: rgba(0,0,0,0.8); padding: 12px; border-right: 4px solid #f44; z-index: 100; text-align: right; }
        .val { font-size: 22px; font-weight: bold; color: white; }
        .touch-controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; box-sizing: border-box; z-index: 100; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.1); border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; user-select: none; }
        #overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: #0ff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; text-align: center; }
        #flash { position: absolute; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 1500; }
    </style>
</head>
<body>
    <div id="flash"></div>
    <div id="overlay">
        <h1 id="m-t">RACE START</h1>
        <p id="m-p">閃避前方車輛！<br>點擊螢幕開始 2 分鐘挑戰</p>
    </div>
    <div id="ui">
        <div>SPD <span id="speed" class="val">0</span></div>
        <div>DIST <span id="dist" class="val">0</span></div>
    </div>
    <div id="timer-box">
        <div id="timer" class="val">02:00</div>
    </div>
    <div class="touch-controls">
        <div style="display:flex; gap:15px;">
            <div class="btn" id="btn-left" style="border-color:#0ff">◀</div>
            <div class="btn" id="btn-right" style="border-color:#0ff">▶</div>
        </div>
        <div style="display:flex; gap:15px;">
            <div class="btn" id="btn-brake" style="border-color:#f44; color:#f44">SHUT</div>
            <div class="btn" id="btn-gas" style="border-color:#4f4; color:#4f4">GO</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, car, gameActive = false;
        let speed = 0, angle = 0, distance = 0, timeLeft = 120;
        let roadSegments = [], enemies = [], state = { gas: false, brake: false, left: false, right: false };
        const SEG_LEN = 10, ROAD_WIDTH = 15, ROAD_LIMIT = 7.5;

        document.getElementById('overlay').onclick = function() {
            if(timeLeft <= 0) location.reload();
            this.style.display = 'none';
            gameActive = true;
            let itv = setInterval(() => {
                if(!gameActive) return;
                timeLeft--;
                let m = Math.floor(timeLeft/60), s = timeLeft%60;
                document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(timeLeft <= 0) { clearInterval(itv); end(); }
            }, 1000);
        };

        function end() {
            gameActive = false;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('m-t').innerText = "FINISH!";
            document.getElementById('m-p').innerText = `最終里程: ${Math.round(distance/10)} M\n點擊重玩`;
        }

        window.onload = init;
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020205);
            scene.fog = new THREE.Fog(0x020205, 20, 150);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            for(let i=0; i<60; i++) addSegment(i);
            
            // 玩家
            car = new THREE.Group();
            car.add(new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 2.8), new THREE.MeshPhongMaterial({color: 0x00ffff})));
            car.position.y = 0.5;
            scene.add(car);

            // 生成 5 輛對手車
            for(let i=0; i<5; i++) spawnEnemy(i);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            setupControls();
            animate();
        }

        function addSegment(index) {
            const z = index * SEG_LEN, x = Math.sin(z * 0.02) * ROAD_WIDTH;
            const group = new THREE.Group();
            const road = new THREE.Mesh(new THREE.PlaneGeometry(18, SEG_LEN + 0.1), new THREE.MeshPhongMaterial({color: index%2==0?0x111111:0x181818}));
            road.rotation.x = -Math.PI/2;
            const lC = new THREE.Mesh(new THREE.BoxGeometry(1, 0.4, SEG_LEN), new THREE.MeshPhongMaterial({color: index%2==0?0xff0000:0xffffff}));
            lC.position.set(-9.5, 0.2, 0);
            const rC = lC.clone(); rC.position.x = 9.5;
            group.add(road, lC, rC);
            group.position.set(x, 0, z);
            scene.add(group);
            roadSegments.push({ mesh: group, z: z, x: x });
        }

        function spawnEnemy(i) {
            const en = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 2.8), new THREE.MeshPhongMaterial({color: 0xff3300}));
            const tail = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.2, 0.1), new THREE.MeshBasicMaterial({color: 0xff0000}));
            tail.position.set(0, 0, 1.4);
            en.add(body, tail);
            en.userData = { speed: 0.15 + Math.random()*0.2, lane: (Math.random()-0.5)*12 };
            en.position.set(0, 0.5, car.position.z + 40 + i*30); // 錯開生成
            scene.add(en);
            enemies.push(en);
        }

        function setupControls() {
            const h = (id, p) => {
                const el = document.getElementById(id);
                el.onpointerdown = (e) => { e.preventDefault(); state[p] = true; };
                el.onpointerup = (e) => { e.preventDefault(); state[p] = false; };
            };
            h('btn-left', 'left'); h('btn-right', 'right');
            h('btn-gas', 'gas'); h('btn-brake', 'brake');
            window.onkeydown = (e) => {
                const k = e.key.toLowerCase();
                if(k=='w'||e.key=='ArrowUp') state.gas = true;
                if(k=='s'||e.key=='ArrowDown') state.brake = true;
                if(k=='a'||e.key=='ArrowLeft') state.left = true;
                if(k=='d'||e.key=='ArrowRight') state.right = true;
            };
            window.onkeyup = (e) => {
                const k = e.key.toLowerCase();
                if(k=='w'||e.key=='ArrowUp') state.gas = false;
                if(k=='s'||e.key=='ArrowDown') state.brake = false;
                if(k=='a'||e.key=='ArrowLeft') state.left = false;
                if(k=='d'||e.key=='ArrowRight') state.right = false;
            };
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameActive) return;

            if (state.gas) speed += 0.015; // 速度減半 50%
            if (state.brake) speed -= 0.08;
            speed *= 0.99;
            if (speed < 0) speed = 0;

            if (state.left) angle += 0.025; // 強化轉向
            if (state.right) angle -= 0.025;
            angle *= 0.85;

            car.position.z += speed * 15;
            car.position.x += angle * (speed * 25 + 3);
            distance += speed * 15;

            // 道路與碰撞
            const roadX = Math.sin(car.position.z * 0.02) * ROAD_WIDTH;
            if (Math.abs(car.position.x - roadX) > ROAD_LIMIT) {
                car.position.x = roadX + (Math.sign(car.position.x - roadX) * ROAD_LIMIT);
                speed *= 0.95;
            }

            // 對手車邏輯
            enemies.forEach(en => {
                en.position.z += en.userData.speed * 15;
                en.position.x = (Math.sin(en.position.z * 0.02) * ROAD_WIDTH) + en.userData.lane;

                // 碰撞檢測
                if(Math.abs(car.position.x - en.position.x) < 1.6 && Math.abs(car.position.z - en.position.z) < 3) {
                    speed *= 0.4;
                    document.getElementById('flash').style.opacity = 1;
                    setTimeout(()=>document.getElementById('flash').style.opacity=0, 100);
                    en.position.z += 15; // 撞到後往前噴
                }

                // 重置到前方
                if(en.position.z < car.position.z - 15) {
                    en.position.z = car.position.z + 120 + Math.random()*50;
                    en.userData.lane = (Math.random()-0.5)*12;
                }
            });

            // 無限跑道
            if (car.position.z > roadSegments[0].z + 150) {
                const old = roadSegments.shift();
                scene.remove(old.mesh);
                const last = roadSegments[roadSegments.length - 1];
                addSegment((last.z / 10) + 1);
            }

            camera.position.set(car.position.x * 0.7, 5, car.position.z - 15);
            camera.lookAt(car.position.x, 1, car.position.z + 20);
            
            document.getElementById('speed').innerText = Math.round(speed * 1200);
            document.getElementById('dist').innerText = Math.round(distance / 10);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
