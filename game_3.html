<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D 賽車 - 極速超車版</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #0ff; background: rgba(0,0,0,0.8); padding: 12px; border-left: 4px solid #0ff; z-index: 100; border-radius: 4px; }
        #timer-box { position: absolute; top: 20px; right: 20px; color: #f44; background: rgba(0,0,0,0.8); padding: 12px; border-right: 4px solid #f44; z-index: 100; text-align: right; }
        .val { font-size: 22px; font-weight: bold; color: white; }
        .touch-controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; box-sizing: border-box; z-index: 100; }
        .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.15); border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; user-select: none; }
        #overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: #0ff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; text-align: center; }
        #flash { position: absolute; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 1500; }
    </style>
</head>
<body>
    <div id="flash"></div>
    <div id="overlay">
        <h1>RACE MODE: WIDE</h1>
        <p>賽道已加寬 30% | NPC 車輛增加至 10 輛<br>點擊螢幕開始 2 分鐘挑戰</p>
    </div>
    <div id="ui">
        <div>SPD <span id="speed" class="val">0</span></div>
        <div>DIST <span id="dist" class="val">0</span></div>
    </div>
    <div id="timer-box">
        <div id="timer" class="val">02:00</div>
    </div>
    <div class="touch-controls">
        <div style="display:flex; gap:15px;">
            <div class="btn" id="btn-left" style="border-color:#0ff">◀</div>
            <div class="btn" id="btn-right" style="border-color:#0ff">▶</div>
        </div>
        <div style="display:flex; gap:15px;">
            <div class="btn" id="btn-brake" style="border-color:#f44; color:#f44">SHUT</div>
            <div class="btn" id="btn-gas" style="border-color:#4f4; color:#4f4">GO</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, car, gameActive = false;
        let speed = 0, angle = 0, distance = 0, timeLeft = 120;
        let roadSegments = [], enemies = [], state = { gas: false, brake: false, left: false, right: false };
        
        // --- 設定參數：寬度增加 30% ---
        const SEG_LEN = 10;
        const BASE_ROAD_WIDTH = 18; // 視覺寬度
        const ROAD_WIDTH_MULT = 1.3; // 加寬 30%
        const ROAD_LIMIT = 9.5; // 可行使半寬 (加寬後的界限)

        document.getElementById('overlay').onclick = function() {
            if(timeLeft <= 0) location.reload();
            this.style.display = 'none';
            gameActive = true;
            let itv = setInterval(() => {
                if(!gameActive) return;
                timeLeft--;
                let m = Math.floor(timeLeft/60), s = timeLeft%60;
                document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(timeLeft <= 0) { clearInterval(itv); end(); }
            }, 1000);
        };

        function end() {
            gameActive = false;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('overlay').querySelector('h1').innerText = "FINISH!";
            document.getElementById('overlay').querySelector('p').innerText = `最終里程: ${Math.round(distance/10)} M\n點擊重玩`;
        }

        window.onload = init;
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020205);
            scene.fog = new THREE.Fog(0x020205, 20, 160);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            for(let i=0; i<60; i++) addSegment(i);
            
            car = new THREE.Group();
            car.add(new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 2.8), new THREE.MeshPhongMaterial({color: 0x00ffff})));
            car.position.y = 0.5;
            scene.add(car);

            // --- 增加至 10 輛對手車 ---
            for(let i=0; i<10; i++) spawnEnemy(i);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            setupControls();
            animate();
        }

        function addSegment(index) {
            const z = index * SEG_LEN, x = Math.sin(z * 0.02) * 15;
            const group = new THREE.Group();
            // 寬度加大至 24 (18 * 1.3 左右)
            const road = new THREE.Mesh(new THREE.PlaneGeometry(24, SEG_LEN + 0.1), new THREE.MeshPhongMaterial({color: index%2==0?0x111111:0x181818}));
            road.rotation.x = -Math.PI/2;
            const curbMat = new THREE.MeshPhongMaterial({color: index%2==0?0xff0000:0xffffff});
            const lC = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.4, SEG_LEN), curbMat);
            lC.position.set(-12.5, 0.2, 0); // 邊界同步加寬
            const rC = lC.clone(); rC.position.x = 12.5;
            group.add(road, lC, rC);
            group.position.set(x, 0, z);
            scene.add(group);
            roadSegments.push({ mesh: group, z: z, x: x });
        }

        function spawnEnemy(i) {
            const en = new THREE.Group();
            const colors = [0xff3300, 0xffaa00, 0x9900ff, 0x00ff00];
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 2.8), new THREE.MeshPhongMaterial({color: colors[i % colors.length]}));
            const tail = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.2, 0.1), new THREE.MeshBasicMaterial({color: 0xff0000}));
            tail.position.set(0, 0, 1.4);
            en.add(body, tail);
            // 隨機分佈在更寬的車道上
            en.userData = { speed: 0.12 + Math.random()*0.15, lane: (Math.random()-0.5)*18 };
            en.position.set(0, 0.5, car.position.z + 50 + i*25);
            scene.add(en);
            enemies.push(en);
        }

        function setupControls() {
            const h = (id, p) => {
                const el = document.getElementById(id);
                el.onpointerdown = (e) => { e.preventDefault(); state[p] = true; };
                el.onpointerup = (e) => { e.preventDefault(); state[p] = false; };
            };
            h('btn-left', 'left'); h('btn-right', 'right');
            h('btn-gas', 'gas'); h('btn-brake', 'brake');
            window.onkeydown = (e) => {
                const k = e.key.toLowerCase();
                if(k=='w'||e.key=='ArrowUp') state.gas = true;
                if(k=='s'||e.key=='ArrowDown') state.brake = true;
                if(k=='a'||e.key=='ArrowLeft') state.left = true;
                if(k=='d'||e.key=='ArrowRight') state.right = true;
            };
            window.onkeyup = (e) => {
                const k = e.key.toLowerCase();
                if(k=='w'||e.key=='ArrowUp') state.gas = false;
                if(k=='s'||e.key=='ArrowDown') state.brake = false;
                if(k=='a'||e.key=='ArrowLeft') state.left = false;
                if(k=='d'||e.key=='ArrowRight') state.right = false;
            };
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameActive) return;

            if (state.gas) speed += 0.015; 
            if (state.brake) speed -= 0.08;
            speed *= 0.99;
            if (speed < 0) speed = 0;

            if (state.left) angle += 0.025; 
            if (state.right) angle -= 0.025;
            angle *= 0.85;

            car.position.z += speed * 15;
            car.position.x += angle * (speed * 25 + 3);
            distance += speed * 15;

            const roadX = Math.sin(car.position.z * 0.02) * 15;
            if (Math.abs(car.position.x - roadX) > ROAD_LIMIT) {
                car.position.x = roadX + (Math.sign(car.position.x - roadX) * ROAD_LIMIT);
                speed *= 0.95;
            }

            enemies.forEach(en => {
                en.position.z += en.userData.speed * 15;
                en.position.x = (Math.sin(en.position.z * 0.02) * 15) + en.userData.lane;
                if(Math.abs(car.position.x - en.position.x) < 1.6 && Math.abs(car.position.z - en.position.z) < 3.2) {
                    speed *= 0.4;
                    document.getElementById('flash').style.opacity = 1;
                    setTimeout(()=>document.getElementById('flash').style.opacity=0, 100);
                    en.position.z += 20; 
                }
                if(en.position.z < car.position.z - 15) {
                    en.position.z = car.position.z + 180 + Math.random()*50;
                    en.userData.lane = (Math.random()-0.5)*18;
                }
            });

            if (car.position.z > roadSegments[0].z + 150) {
                const old = roadSegments.shift();
                scene.remove(old.mesh);
                const last = roadSegments[roadSegments.length - 1];
                addSegment((last.z / 10) + 1);
            }

            camera.position.set(car.position.x * 0.7, 5.5, car.position.z - 15);
            camera.lookAt(car.position.x, 1, car.position.z + 20);
            
            document.getElementById('speed').innerText = Math.round(speed * 1200);
            document.getElementById('dist').innerText = Math.round(distance / 10);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
