<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D 賽車 - 2分對抗賽</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #0ff; background: rgba(0,0,0,0.8); padding: 15px; border-left: 4px solid #0ff; z-index: 100; pointer-events: none; border-radius: 4px; }
        #timer-box { position: absolute; top: 20px; right: 20px; color: #f44; background: rgba(0,0,0,0.8); padding: 15px; border-right: 4px solid #f44; z-index: 100; text-align: right; }
        .val { font-size: 24px; font-weight: bold; color: white; }
        
        .touch-controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; box-sizing: border-box; z-index: 100; }
        .btn { width: 85px; height: 85px; background: rgba(255,255,255,0.1); border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; user-select: none; }
        
        #overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: #0ff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; text-align: center; }
        #flash { position: absolute; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 1500; }
    </style>
</head>
<body>

    <div id="flash"></div>

    <div id="overlay">
        <h1 id="msg-title">READY?</h1>
        <p id="msg-p">點擊螢幕開始 2 分鐘比賽<br>閃避其他車輛，跑得越遠越高分！</p>
    </div>

    <div id="ui">
        <div>SPD <span id="speed" class="val">0</span> <span style="font-size:12px">KM/H</span></div>
        <div>DIST <span id="dist" class="val">0</span> <span style="font-size:12px">M</span></div>
    </div>

    <div id="timer-box">
        <div style="font-size:12px">TIME LEFT</div>
        <div id="timer" class="val">02:00</div>
    </div>

    <div class="touch-controls">
        <div style="display:flex; gap:20px;">
            <div class="btn" id="btn-left" style="border-color:#0ff">◀</div>
            <div class="btn" id="btn-right" style="border-color:#0ff">▶</div>
        </div>
        <div style="display:flex; gap:20px;">
            <div class="btn" id="btn-brake" style="border-color:#f44; color:#f44">SHUT</div>
            <div class="btn" id="btn-gas" style="border-color:#4f4; color:#4f4">GO</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        let scene, camera, renderer, car;
        let speed = 0, angle = 0, distance = 0, gameActive = false;
        let timeLeft = 120; // 2分鐘
        let roadSegments = [];
        let enemies = [];
        const state = { gas: false, brake: false, left: false, right: false };

        const SEG_COUNT = 60;
        const SEG_LEN = 10;
        const ROAD_WIDTH = 15;
        const ROAD_LIMIT = 7.2;

        document.getElementById('overlay').onclick = function() {
            if(timeLeft <= 0) location.reload(); // 結束後點擊重開
            this.style.display = 'none';
            gameActive = true;
            startTimer();
        };

        function startTimer() {
            const timerInt = setInterval(() => {
                if(!gameActive) return;
                timeLeft--;
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                document.getElementById('timer').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(timeLeft <= 0) {
                    clearInterval(timerInt);
                    gameOver();
                }
            }, 1000);
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('msg-title').innerText = "TIME UP!";
            document.getElementById('msg-p').innerHTML = `比賽結束！您的里程：${Math.round(distance/10)} M<br>點擊螢幕重新開始`;
        }

        window.onload = init;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050508);
            scene.fog = new THREE.Fog(0x050508, 20, 150);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 生成道路
            for(let i=0; i<SEG_COUNT; i++) addSegment(i);

            // 玩家賽車
            car = new THREE.Group();
            car.add(new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 2.8), new THREE.MeshPhongMaterial({color: 0x00ffff, emissive: 0x002222})));
            car.position.y = 0.5;
            scene.add(car);

            // 生成對手車輛 (NPC)
            for(let i=0; i<3; i++) spawnEnemy();

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            setupControls();
            animate();
        }

        function addSegment(index) {
            const z = index * SEG_LEN;
            const x = Math.sin(z * 0.02) * ROAD_WIDTH;
            const group = new THREE.Group();
            const road = new THREE.Mesh(new THREE.PlaneGeometry(18, SEG_LEN + 0.1), new THREE.MeshPhongMaterial({color: index%2==0?0x111111:0x161616}));
            road.rotation.x = -Math.PI/2;
            group.add(road);
            const curbMat = new THREE.MeshPhongMaterial({color: index%2==0?0xff0000:0xffffff});
            const lC = new THREE.Mesh(new THREE.BoxGeometry(1, 0.4, SEG_LEN), curbMat); lC.position.set(-9.5, 0.2, 0);
            const rC = lC.clone(); rC.position.x = 9.5;
            group.add(lC, rC);
            group.position.set(x, 0, z);
            scene.add(group);
            roadSegments.push({ mesh: group, z: z, x: x });
        }

        function spawnEnemy() {
            const enemy = new THREE.Group();
            const colors = [0xffaa00, 0xff00ff, 0x00ff00];
            enemy.add(new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 2.8), new THREE.MeshPhongMaterial({color: colors[Math.floor(Math.random()*3)]})));
            enemy.position.y = 0.5;
            enemy.userData = { 
                speed: 0.2 + Math.random() * 0.3, 
                lane: (Math.random() - 0.5) * 10 
            };
            // 放在玩家前方 50~150 單位
            enemy.position.z = car.position.z + 50 + Math.random() * 100;
            scene.add(enemy);
            enemies.push(enemy);
        }

        function setupControls() {
            const h = (id, p) => {
                const el = document.getElementById(id);
                el.onpointerdown = (e) => { e.preventDefault(); state[p] = true; };
                el.onpointerup = (e) => { e.preventDefault(); state[p] = false; };
            };
            h('btn-left', 'left'); h('btn-right', 'right');
            h('btn-gas', 'gas'); h('btn-brake', 'brake');
            window.onkeydown = (e) => {
                const k = e.key.toLowerCase();
                if(k=='w'||e.key=='ArrowUp') state.gas = true;
                if(k=='s'||e.key=='ArrowDown') state.brake = true;
                if(k=='a'||e.key=='ArrowLeft') state.left = true;
                if(k=='d'||e.key=='ArrowRight') state.right = true;
            };
            window.onkeyup = (e) => {
                const k = e.key.toLowerCase();
                if(k=='w'||e.key=='ArrowUp') state.gas = false;
                if(k=='s'||e.key=='ArrowDown') state.brake = false;
                if(k=='a'||e.key=='ArrowLeft') state.left = false;
                if(k=='d'||e.key=='ArrowRight') state.right = false;
            };
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameActive) return;

            // 速度減少 50% (原 0.03 -> 0.015)
            if (state.gas) speed += 0.012; 
            if (state.brake) speed -= 0.08;
            speed *= 0.99;
            if (speed < 0) speed = 0;

            if (state.left) angle += 0.02;
            if (state.right) angle -= 0.02;
            angle *= 0.85;

            car.position.z += speed * 15;
            car.position.x += angle * (speed * 25 + 2);
            distance += speed * 15;

            // 道路與碰撞
            const idealX = Math.sin(car.position.z * 0.02) * ROAD_WIDTH;
            const drift = car.position.x - idealX;
            if (Math.abs(drift) > ROAD_LIMIT) {
                car.position.x = idealX + (Math.sign(drift) * ROAD_LIMIT);
                speed *= 0.95;
            }

            // NPC 車輛邏輯
            enemies.forEach(en => {
                en.position.z += en.userData.speed * 15;
                const enRoadX = Math.sin(en.position.z * 0.02) * ROAD_WIDTH;
                en.position.x = enRoadX + en.userData.lane;

                // 碰撞檢測 (簡單距離判定)
                let dx = car.position.x - en.position.x;
                let dz = car.position.z - en.position.z;
                if(Math.abs(dx) < 1.5 && Math.abs(dz) < 2.8) {
                    speed *= 0.5; // 撞車大減速
                    en.position.z += 10; // 彈開
                    document.getElementById('flash').style.opacity = 1;
                    setTimeout(() => document.getElementById('flash').style.opacity = 0, 100);
                }

                // NPC 車跑太遠就重置到前方
                if(en.position.z < car.position.z - 20) {
                    en.position.z = car.position.z + 150;
                    en.userData.lane = (Math.random() - 0.5) * 12;
                }
            });

            // 無限跑道
            if (car.position.z > roadSegments[0].z + SEG_LEN * 15) {
                const old = roadSegments.shift();
                scene.remove(old.mesh);
                const last = roadSegments[roadSegments.length - 1];
                addSegment((last.z / SEG_LEN) + 1);
            }

            camera.position.set(car.position.x * 0.7, 5, car.position.z - 15);
            camera.lookAt(car.position.x, 1, car.position.z + 20);
            
            document.getElementById('speed').innerText = Math.round(speed * 1200);
            document.getElementById('dist').innerText = Math.round(distance / 10);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
